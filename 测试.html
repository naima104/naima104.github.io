<!DOCTYPE html>
<html>
<head>
    <title>百万级粒子系统</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; }
        canvas { display: block; }
        #domContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: none;
        }
        .panel {
            position: fixed;
            top: 10px;
            left: 10px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 8px;
            font-family: Arial;
            max-width: 300px;
        }
        .switch { margin: 10px 0; }
        .tooltip {
            display: none;
            background: #333;
            color: #fff;
            padding: 5px;
            border-radius: 4px;
            margin-top: 5px;
        }
        label:hover .tooltip { display: block; }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <div id="domContainer"></div>
    <div class="panel">
        <h3>百万级粒子系统</h3>
        
        <div class="switch">
            <label>
                <input type="checkbox" id="renderMode" checked>
                使用Canvas渲染
                <div class="tooltip">Canvas模式可支持百万级粒子渲染</div>
            </label>
        </div>
        
        <div class="switch">
            <label>
                <input type="checkbox" id="hqMode">
                超高清模式
                <div class="tooltip">启用更高分辨率渲染（仅Canvas模式有效）</div>
            </label>
        </div>
        
        <div>粒子数量: <span id="count">0</span>/1,000,000</div>
        <div>FPS: <span id="fps">0</span></div>
        <div>渲染模式: <span id="modeInfo">Canvas</span></div>
    </div>

<script>
class MillionParticleSystem {
    constructor() {
        // 系统配置
        this.MAX_PARTICLES = 1_000_000;
        this.PARTICLES_PER_FRAME = 5000;
        
        // 渲染元素
        this.canvas = document.getElementById('canvas');
        this.ctx = this.canvas.getContext('2d');
        this.domContainer = document.getElementById('domContainer');
        
        // 状态控制
        this.useCanvas = true;
        this.hqMode = false;
        this.particles = [];
        this.domParticles = [];
        
        // 性能监控
        this.lastTime = performance.now();
        this.frameCount = 0;
        
        this.init();
    }

    init() {
        this.resize();
        this.setupControls();
        this.animate();
        
        // 初始加载10万粒子
        this.addParticles(100000);
    }

    resize() {
        const dpr = this.hqMode ? devicePixelRatio : 1;
        this.canvas.width = innerWidth * dpr;
        this.canvas.height = innerHeight * dpr;
        this.canvas.style.width = innerWidth + 'px';
        this.canvas.style.height = innerHeight + 'px';
        this.ctx.scale(dpr, dpr);
    }

    setupControls() {
        // 渲染模式切换
        document.getElementById('renderMode').addEventListener('change', (e) => {
            this.useCanvas = e.target.checked;
            this.canvas.style.display = this.useCanvas ? 'block' : 'none';
            this.domContainer.style.display = this.useCanvas ? 'none' : 'block';
            
            if (!this.useCanvas && this.domParticles.length === 0) {
                this.createDomParticles();
            }
            
            document.getElementById('modeInfo').textContent = 
                this.useCanvas ? 'Canvas' : 'DOM';
            
            console.log(`切换到${this.useCanvas ? 'Canvas' : 'DOM'}渲染模式`);
        });

        // 超高清模式
        document.getElementById('hqMode').addEventListener('change', (e) => {
            this.hqMode = e.target.checked;
            if (this.useCanvas) this.resize();
            console.log(`超高清模式${this.hqMode ? '开启' : '关闭'}`);
        });
    }

    addParticles(count) {
        const start = this.particles.length;
        const end = Math.min(start + count, this.MAX_PARTICLES);
        
        for (let i = start; i < end; i++) {
            const p = {
                x: Math.random() * innerWidth,
                y: Math.random() * innerHeight,
                vx: (Math.random() - 0.5) * 0.5, // 降低速度
                vy: (Math.random() - 0.5) * 0.5,
                color: this.getParticleColor(i),
                size: Math.random() * 1 + 0.5 // 减小粒子尺寸
            };
            this.particles.push(p);
            
            if (!this.useCanvas) {
                this.createDomParticle(p);
            }
        }
        
        document.getElementById('count').textContent = 
            this.particles.length.toLocaleString();
        
        // 分批加载避免卡顿
        if (this.particles.length < this.MAX_PARTICLES && 
            this.particles.length < end) {
            requestAnimationFrame(() => {
                this.addParticles(this.PARTICLES_PER_FRAME);
            });
        }
    }

    getParticleColor(index) {
        // 使用HSV色彩空间分布更均匀
        const hue = (index * 137.508) % 360; // 黄金角度分布
        return `hsl(${hue}, 80%, 60%)`;
    }

    createDomParticles() {
        this.domContainer.innerHTML = '';
        this.domParticles = new Array(this.particles.length);
        
        // 使用文档片段批量插入
        const fragment = document.createDocumentFragment();
        this.particles.forEach((p, i) => {
            const particle = this.createDomParticle(p);
            fragment.appendChild(particle);
            this.domParticles[i] = particle;
        });
        this.domContainer.appendChild(fragment);
    }

    createDomParticle(p) {
        const particle = document.createElement('div');
        particle.className = 'dom-particle';
        particle.style.cssText = `
            position: absolute;
            width: ${p.size * 2}px;
            height: ${p.size * 2}px;
            border-radius: 50%;
            background: ${p.color};
            transform: translate(${p.x - p.size}px, ${p.y - p.size}px);
            will-change: transform;
        `;
        return particle;
    }

    update() {
        const { innerWidth, innerHeight } = window;
        
        // 使用for循环比forEach更快
        for (let i = 0, len = this.particles.length; i < len; i++) {
            const p = this.particles[i];
            
            // 更新位置
            p.x += p.vx;
            p.y += p.vy;
            
            // 边界检测
            if (p.x < 0 || p.x > innerWidth) p.vx *= -0.95;
            if (p.y < 0 || p.y > innerHeight) p.vy *= -0.95;
            
            // 更新DOM粒子
            if (!this.useCanvas && this.domParticles[i]) {
                this.domParticles[i].style.transform = 
                    `translate(${p.x - p.size}px, ${p.y - p.size}px)`;
            }
        }
    }

    drawCanvas() {
        // 使用更高效的清屏方式
        this.ctx.globalCompositeOperation = 'source-over';
        this.ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        
        // 批量绘制粒子
        this.ctx.fillStyle = 'red'; // 初始颜色，实际会被覆盖
        for (let i = 0, len = this.particles.length; i < len; i++) {
            const p = this.particles[i];
            this.ctx.fillStyle = p.color;
            this.ctx.beginPath();
            
            // 简化绘制调用
            if (this.hqMode) {
                this.ctx.arc(p.x, p.y, p.size * 1.2, 0, Math.PI * 2);
            } else {
                // 更快的矩形绘制（近似圆形）
                this.ctx.rect(p.x - p.size, p.y - p.size, p.size * 2, p.size * 2);
            }
            this.ctx.fill();
        }
    }

    animate() {
        const now = performance.now();
        const deltaTime = now - this.lastTime;
        this.lastTime = now;
        this.frameCount++;
        
        // 更新FPS显示（每秒更新）
        if (this.frameCount % 10 === 0) {
            document.getElementById('fps').textContent = 
                Math.round(1000 / deltaTime);
        }
        
        this.update();
        if (this.useCanvas) this.drawCanvas();
        
        // 自动增加粒子直到百万
        if (this.particles.length < this.MAX_PARTICLES && 
            now % 1000 < deltaTime) {
            this.addParticles(this.PARTICLES_PER_FRAME);
        }
        
        requestAnimationFrame(() => this.animate());
    }
}

// 启动百万粒子系统
new MillionParticleSystem();
</script>
</body>
</html>